"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = exports.successResponse = exports.errorResponse = exports.callCfn = void 0;
const https = require("https");
const url = require("url");
exports.callCfn = async (body, cfnUrl) => {
    const parsedUrl = url.parse(cfnUrl);
    const options = {
        hostname: parsedUrl.hostname,
        port: 443,
        path: parsedUrl.path,
        method: "PUT",
        headers: {
            "content-type": "application/json",
            "content-length": JSON.stringify(body).length,
        },
    };
    console.info("SENDING RESPONSE...");
    return new Promise((resolve, reject) => {
        const request = https.request(options, (response) => {
            console.info("STATUS", response.statusCode);
            console.info("HEADERS", response.headers);
            resolve(response);
        });
        request.on("error", (error) => {
            console.info("sendResponse Error:" + error);
            reject(error);
        });
        request.write(JSON.stringify(body));
        request.end();
    });
};
exports.errorResponse = async (message, { cfnUrl, cfnStackId, cfnRequestId, logicalResourceId }) => {
    await exports.callCfn({
        "Status": "FAILED",
        "Reason": message,
        "PhysicalResourceId": logicalResourceId,
        "StackId": cfnStackId,
        "RequestId": cfnRequestId,
        "LogicalResourceId": logicalResourceId,
    }, cfnUrl);
};
exports.successResponse = async ({ cfnUrl, cfnStackId, cfnRequestId, logicalResourceId }) => {
    await exports.callCfn({
        "Status": "SUCCESS",
        "PhysicalResourceId": logicalResourceId,
        "StackId": cfnStackId,
        "RequestId": cfnRequestId,
        "LogicalResourceId": logicalResourceId,
    }, cfnUrl);
};
exports.handler = async (event) => {
    console.info('EVENT', event);
    const { ResponseURL: cfnUrl, StackId: cfnStackId, RequestId: cfnRequestId, LogicalResourceId: logicalResourceId, } = event.ExecutionInput;
    const errors = [];
    const lambdaResults = event.IntegrationTestResults;
    const parallelSuccess = Array.isArray(lambdaResults);
    if (!parallelSuccess)
        return exports.errorResponse("Execution error in parallel state", {
            cfnUrl, cfnStackId, cfnRequestId, logicalResourceId
        });
    lambdaResults.map((result) => {
        if (!result.success)
            errors.push(result.testName);
    });
    if (errors.length)
        return exports.errorResponse(`Tests failed: [${errors.join(', ')}]`, {
            cfnUrl, cfnStackId, cfnRequestId, logicalResourceId
        });
    return exports.successResponse({ cfnUrl, cfnStackId, cfnRequestId, logicalResourceId });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwrQkFBK0I7QUFDL0IsMkJBQTJCO0FBeUNkLFFBQUEsT0FBTyxHQUFHLEtBQUssRUFBRSxJQUFpQixFQUFFLE1BQWMsRUFBRSxFQUFFO0lBQy9ELE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDcEMsTUFBTSxPQUFPLEdBQUc7UUFDWixRQUFRLEVBQUUsU0FBUyxDQUFDLFFBQVE7UUFDNUIsSUFBSSxFQUFFLEdBQUc7UUFDVCxJQUFJLEVBQUUsU0FBUyxDQUFDLElBQUk7UUFDcEIsTUFBTSxFQUFFLEtBQUs7UUFDYixPQUFPLEVBQUU7WUFDTCxjQUFjLEVBQUUsa0JBQWtCO1lBQ2xDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTTtTQUNoRDtLQUNKLENBQUM7SUFFRixPQUFPLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFFcEMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUVuQyxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLFFBQWEsRUFBRSxFQUFFO1lBQ3JELE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUM1QyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDMUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ3JCLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFVLEVBQUUsRUFBRTtZQUMvQixPQUFPLENBQUMsSUFBSSxDQUFDLHFCQUFxQixHQUFHLEtBQUssQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNqQixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUNsQixDQUFDLENBQUMsQ0FBQTtBQUVOLENBQUMsQ0FBQTtBQUVZLFFBQUEsYUFBYSxHQUFHLEtBQUssRUFBRSxPQUFlLEVBQUUsRUFDakQsTUFBTSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQzFDLEVBQUUsRUFBRTtJQUNiLE1BQU0sZUFBTyxDQUFDO1FBQ1YsUUFBUSxFQUFFLFFBQVE7UUFDbEIsUUFBUSxFQUFFLE9BQU87UUFDakIsb0JBQW9CLEVBQUUsaUJBQWlCO1FBQ3ZDLFNBQVMsRUFBRSxVQUFVO1FBQ3JCLFdBQVcsRUFBRSxZQUFZO1FBQ3pCLG1CQUFtQixFQUFFLGlCQUFpQjtLQUN6QyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0FBQ2QsQ0FBQyxDQUFBO0FBRVksUUFBQSxlQUFlLEdBQUcsS0FBSyxFQUFFLEVBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQWEsRUFBRSxFQUFFO0lBQ3ZHLE1BQU0sZUFBTyxDQUFDO1FBQ1YsUUFBUSxFQUFFLFNBQVM7UUFDbkIsb0JBQW9CLEVBQUUsaUJBQWlCO1FBQ3ZDLFNBQVMsRUFBRSxVQUFVO1FBQ3JCLFdBQVcsRUFBRSxZQUFZO1FBQ3pCLG1CQUFtQixFQUFFLGlCQUFpQjtLQUN6QyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0FBQ2QsQ0FBQyxDQUFBO0FBRVksUUFBQSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQVksRUFBRSxFQUFFO0lBQzFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFBO0lBQzVCLE1BQU0sRUFDRixXQUFXLEVBQUUsTUFBTSxFQUNuQixPQUFPLEVBQUUsVUFBVSxFQUNuQixTQUFTLEVBQUUsWUFBWSxFQUN2QixpQkFBaUIsRUFBRSxpQkFBaUIsR0FDdkMsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFBO0lBQ3hCLE1BQU0sTUFBTSxHQUFrQixFQUFFLENBQUE7SUFDaEMsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLHNCQUFzQixDQUFBO0lBQ2xELE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUE7SUFFcEQsSUFBSSxDQUFDLGVBQWU7UUFDaEIsT0FBTyxxQkFBYSxDQUFDLG1DQUFtQyxFQUFFO1lBQ3RELE1BQU0sRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLGlCQUFpQjtTQUN0RCxDQUFDLENBQUE7SUFFTixhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7UUFDekIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPO1lBQ2YsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDcEMsQ0FBQyxDQUFDLENBQUE7SUFFRixJQUFJLE1BQU0sQ0FBQyxNQUFNO1FBQ2IsT0FBTyxxQkFBYSxDQUFDLGtCQUFrQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDekQsTUFBTSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsaUJBQWlCO1NBQ3RELENBQUMsQ0FBQTtJQUNOLE9BQU8sdUJBQWUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLGlCQUFpQixFQUFDLENBQUMsQ0FBQTtBQUNqRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBodHRwcyBmcm9tIFwiaHR0cHNcIjtcbmltcG9ydCAqIGFzIHVybCBmcm9tIFwidXJsXCI7XG5cbmludGVyZmFjZSBUZXN0UmVzdWx0IHtcbiAgICBzdWNjZXNzOiBib29sZWFuO1xuICAgIHRlc3ROYW1lOiBzdHJpbmc7XG4gICAgZXJyb3JNZXNzYWdlOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBFdmVudCB7XG4gICAgRXhlY3V0aW9uSW5wdXQ6IHtcbiAgICAgICAgUmVxdWVzdFR5cGU6IHN0cmluZ1xuICAgICAgICBTZXJ2aWNlVG9rZW46IHN0cmluZ1xuICAgICAgICBSZXNwb25zZVVSTDogc3RyaW5nXG4gICAgICAgIFN0YWNrSWQ6IHN0cmluZ1xuICAgICAgICBSZXF1ZXN0SWQ6IHN0cmluZ1xuICAgICAgICBMb2dpY2FsUmVzb3VyY2VJZDogc3RyaW5nXG4gICAgICAgIFJlc291cmNlVHlwZTogc3RyaW5nXG4gICAgICAgIFJlc291cmNlUHJvcGVydGllczoge1xuICAgICAgICAgICAgU2VydmljZVRva2VuOiBzdHJpbmdcbiAgICAgICAgICAgIEV4ZWN1dGlvblRpbWU6IHN0cmluZ1xuICAgICAgICB9XG4gICAgfSxcbiAgICBJbnRlZ3JhdGlvblRlc3RSZXN1bHRzOiBBcnJheTxUZXN0UmVzdWx0PlxufVxuXG5pbnRlcmZhY2UgU3RhY2tQcm9wcyB7XG4gICAgY2ZuVXJsOiBzdHJpbmc7XG4gICAgY2ZuU3RhY2tJZDogc3RyaW5nO1xuICAgIGNmblJlcXVlc3RJZDogc3RyaW5nO1xuICAgIGxvZ2ljYWxSZXNvdXJjZUlkOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBDZm5SZXNwb25zZSB7XG4gICAgU3RhdHVzOiBzdHJpbmc7XG4gICAgUmVhc29uPzogc3RyaW5nLFxuICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogc3RyaW5nO1xuICAgIFN0YWNrSWQ6IHN0cmluZztcbiAgICBSZXF1ZXN0SWQ6IHN0cmluZztcbiAgICBMb2dpY2FsUmVzb3VyY2VJZDogc3RyaW5nO1xufVxuXG5leHBvcnQgY29uc3QgY2FsbENmbiA9IGFzeW5jIChib2R5OiBDZm5SZXNwb25zZSwgY2ZuVXJsOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBwYXJzZWRVcmwgPSB1cmwucGFyc2UoY2ZuVXJsKTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICBob3N0bmFtZTogcGFyc2VkVXJsLmhvc3RuYW1lLFxuICAgICAgICBwb3J0OiA0NDMsXG4gICAgICAgIHBhdGg6IHBhcnNlZFVybC5wYXRoLFxuICAgICAgICBtZXRob2Q6IFwiUFVUXCIsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgIFwiY29udGVudC10eXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgICAgXCJjb250ZW50LWxlbmd0aFwiOiBKU09OLnN0cmluZ2lmeShib2R5KS5sZW5ndGgsXG4gICAgICAgIH0sXG4gICAgfTtcblxuICAgIGNvbnNvbGUuaW5mbyhcIlNFTkRJTkcgUkVTUE9OU0UuLi5cIik7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSBodHRwcy5yZXF1ZXN0KG9wdGlvbnMsIChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oXCJTVEFUVVNcIiwgcmVzcG9uc2Uuc3RhdHVzQ29kZSk7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oXCJIRUFERVJTXCIsIHJlc3BvbnNlLmhlYWRlcnMpO1xuICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVxdWVzdC5vbihcImVycm9yXCIsIChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oXCJzZW5kUmVzcG9uc2UgRXJyb3I6XCIgKyBlcnJvcik7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJlcXVlc3Qud3JpdGUoSlNPTi5zdHJpbmdpZnkoYm9keSkpO1xuICAgICAgICByZXF1ZXN0LmVuZCgpO1xuICAgIH0pXG5cbn1cblxuZXhwb3J0IGNvbnN0IGVycm9yUmVzcG9uc2UgPSBhc3luYyAobWVzc2FnZTogc3RyaW5nLCB7XG4gICAgY2ZuVXJsLCBjZm5TdGFja0lkLCBjZm5SZXF1ZXN0SWQsIGxvZ2ljYWxSZXNvdXJjZUlkXG59OiBTdGFja1Byb3BzKSA9PiB7XG4gICAgYXdhaXQgY2FsbENmbih7XG4gICAgICAgIFwiU3RhdHVzXCI6IFwiRkFJTEVEXCIsXG4gICAgICAgIFwiUmVhc29uXCI6IG1lc3NhZ2UsXG4gICAgICAgIFwiUGh5c2ljYWxSZXNvdXJjZUlkXCI6IGxvZ2ljYWxSZXNvdXJjZUlkLFxuICAgICAgICBcIlN0YWNrSWRcIjogY2ZuU3RhY2tJZCxcbiAgICAgICAgXCJSZXF1ZXN0SWRcIjogY2ZuUmVxdWVzdElkLFxuICAgICAgICBcIkxvZ2ljYWxSZXNvdXJjZUlkXCI6IGxvZ2ljYWxSZXNvdXJjZUlkLFxuICAgIH0sIGNmblVybClcbn1cblxuZXhwb3J0IGNvbnN0IHN1Y2Nlc3NSZXNwb25zZSA9IGFzeW5jICh7Y2ZuVXJsLCBjZm5TdGFja0lkLCBjZm5SZXF1ZXN0SWQsIGxvZ2ljYWxSZXNvdXJjZUlkfTogU3RhY2tQcm9wcykgPT4ge1xuICAgIGF3YWl0IGNhbGxDZm4oe1xuICAgICAgICBcIlN0YXR1c1wiOiBcIlNVQ0NFU1NcIixcbiAgICAgICAgXCJQaHlzaWNhbFJlc291cmNlSWRcIjogbG9naWNhbFJlc291cmNlSWQsXG4gICAgICAgIFwiU3RhY2tJZFwiOiBjZm5TdGFja0lkLFxuICAgICAgICBcIlJlcXVlc3RJZFwiOiBjZm5SZXF1ZXN0SWQsXG4gICAgICAgIFwiTG9naWNhbFJlc291cmNlSWRcIjogbG9naWNhbFJlc291cmNlSWQsXG4gICAgfSwgY2ZuVXJsKVxufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogRXZlbnQpID0+IHtcbiAgICBjb25zb2xlLmluZm8oJ0VWRU5UJywgZXZlbnQpXG4gICAgY29uc3Qge1xuICAgICAgICBSZXNwb25zZVVSTDogY2ZuVXJsLFxuICAgICAgICBTdGFja0lkOiBjZm5TdGFja0lkLFxuICAgICAgICBSZXF1ZXN0SWQ6IGNmblJlcXVlc3RJZCxcbiAgICAgICAgTG9naWNhbFJlc291cmNlSWQ6IGxvZ2ljYWxSZXNvdXJjZUlkLFxuICAgIH0gPSBldmVudC5FeGVjdXRpb25JbnB1dFxuICAgIGNvbnN0IGVycm9yczogQXJyYXk8c3RyaW5nPiA9IFtdXG4gICAgY29uc3QgbGFtYmRhUmVzdWx0cyA9IGV2ZW50LkludGVncmF0aW9uVGVzdFJlc3VsdHNcbiAgICBjb25zdCBwYXJhbGxlbFN1Y2Nlc3MgPSBBcnJheS5pc0FycmF5KGxhbWJkYVJlc3VsdHMpXG5cbiAgICBpZiAoIXBhcmFsbGVsU3VjY2VzcylcbiAgICAgICAgcmV0dXJuIGVycm9yUmVzcG9uc2UoXCJFeGVjdXRpb24gZXJyb3IgaW4gcGFyYWxsZWwgc3RhdGVcIiwge1xuICAgICAgICAgICAgY2ZuVXJsLCBjZm5TdGFja0lkLCBjZm5SZXF1ZXN0SWQsIGxvZ2ljYWxSZXNvdXJjZUlkXG4gICAgICAgIH0pXG5cbiAgICBsYW1iZGFSZXN1bHRzLm1hcCgocmVzdWx0KSA9PiB7XG4gICAgICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpXG4gICAgICAgICAgICBlcnJvcnMucHVzaChyZXN1bHQudGVzdE5hbWUpXG4gICAgfSlcblxuICAgIGlmIChlcnJvcnMubGVuZ3RoKVxuICAgICAgICByZXR1cm4gZXJyb3JSZXNwb25zZShgVGVzdHMgZmFpbGVkOiBbJHtlcnJvcnMuam9pbignLCAnKX1dYCwge1xuICAgICAgICAgICAgY2ZuVXJsLCBjZm5TdGFja0lkLCBjZm5SZXF1ZXN0SWQsIGxvZ2ljYWxSZXNvdXJjZUlkXG4gICAgICAgIH0pXG4gICAgcmV0dXJuIHN1Y2Nlc3NSZXNwb25zZSh7Y2ZuVXJsLCBjZm5TdGFja0lkLCBjZm5SZXF1ZXN0SWQsIGxvZ2ljYWxSZXNvdXJjZUlkfSlcbn0iXX0=